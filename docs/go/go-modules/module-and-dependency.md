# Go 依赖管理及 Go module 使用

## 1. 语义化版本控制

软件版本控制帮助我们通过唯一的名称或编号来识别软件或软件包的状态。版本可帮助开发人员跟踪他们正在使用的第三方软件或软件包的更改。

版本控制方案有多种类型，其中一种流行的方案被称为语义版本控制 (SemVer)方案。

在 SemVer 版本控制方案下，我们的版本控制将采用以下格式：

`X.Y.Z-pre-release+build`

其中 x、y 和 z 是数字递增的整数，分别表示 Major、Minor 和 Patch。

SemVer 规范假设使用此方案的项目必须具有公共 API。基于此，我们从左到右依次详细了解一下各个部分。

* Major

当我们引入了破坏 API 的新功能时，`Major`应该增加，即当我们向项目添加向后不兼容的更改时增加此值。当这个数字增加时，我们必须将`Minor`和`Patch`编号重置为0。

例如，如果我们有一个版本为1.2.5的项目，并且我们在 SemVer 方案下引入了重大更改，则必须将新版本号设置为2.0.0。

* Minor

当我们引入改变 API 但向后兼容的新功能（即非破坏性更改）时，我们应该增加`Minor`版本。如果我们对项目的内部代码进行了实质性更改，我们也可以选择更改次要版本。

同样，当我们更改`Minor`版本时，我们也应该将`Patch`版本重置为0。例如，将项目的`Minor`版本更新为2.0.1，会将其设置为2.1.0。

* Patch

根据 SemVer 规范，我们保留补丁更改以用于向后兼容的错误修复。补丁更改不应涉及对 API 的任何更改。

* Pre-Release and Build

在补丁版本之后，我们还可以为版本添加一些可选标签，如预发布标签或内部版本号。

例如，要将软件包标记为预发布版本，我们必须在版本后加上一个连字符，然后添加预发布标签，该标签可以是一个点分隔标识符，例如，1.0.0-alpha.1 表示该项目是标有 alpha.1 的 1.0.0 的预发布版本。 预发布版本标签表示该版本不稳定，如果我们使用该版本，风险很高。在考虑版本优先级时，预发布版本的优先级总是低于正常版本。

如果我们想指示该版本的构建，我们可以使用 + 号在补丁（或预发布）之后添加一个以点分隔的构建标识符。例如，1.0.0-alpha.1+001。构建元数据不考虑优先级，因此我们可以将仅构建号不同的两个版本视为具有相同的优先级

* 0.x.y

SemVer 规范保留主要版本0.x.y用于开发目的。当开始一个新项目时，从0.1.0版本初始开发是有意义的，因为它当然会包含功能。SemVer 假定开发版本不稳定并且可能随时更改。

## 2. 模块、包和版本

模块是一起发布、版本控制和分发的包的集合。模块可以直接从版本控制存储库或模块代理服务器下载。

一个模块由一个模块路径标识，该路径在 go.mod 文件中声明，并附有该模块的依赖关系信息。模块根目录是包含 go.mod 文件的目录。主模块是包行了运行 go command 的目录所在的模块。

模块中的每个软件包都是同一目录下编译在一起的源文件集合。包路径是模块路径与包含包的子目录（相对于模块根目录）的连接。例如，模块 "golang.org/x/net "包含一个目录为 "html "的包。该软件包的路径是 "golang.org/x/net/html"。

模块路径是模块的规范名称。模块路径是模块内软件包路径的前缀。

模块路径既要说明模块的功能，也要说明在哪里可以找到它。通常，模块路径由版本库根目录、版本库中的目录（通常为空）和主版本后缀（仅适用于主版本 2 或更高版本）组成。

版本是模块的不可变快照，Go 版本都以字母 v 开头，后面跟一个语义版本。

伪版本是一种特殊格式的预发布版本，指没有语义版本标签的修订版本。例如，在开发分支上，它们可用于在创建版本标记前测试提交。例如，v0.0.0-20191109021931-daa7c04131f5是一个伪版本。每个伪版本由三部分组成：基本版本前缀、时间戳、修订标识符。

从主版本 2 开始，模块路径必须有一个与主版本相匹配的主版本后缀，如 /v2。例如，如果一个模块的路径 example.com/mod 是 v1.0.0，那么它的路径 example.com/mod/v2 就必须是 v2.0.0 版本。

## 3. Go Modules 使用

### 3.1 初始化模块

go mod init 在当前目录下初始化一个新的 Go 模块项目。它会生成一个 go.mod 文件，其中包含有关模块、模块依赖关系和版本限制的信息。

```go
go mod init example.com/myproject
```

用模块路径替换 example.com/myproject

### 3.2 添加依赖

要添加新的依赖项，您所需要做的就是在 Go 代码中导入所需的包。例如，如果您想添加 `github.com/gorilla/mux` 到项目中，请像这样导入：

```go
import (
  "github.com/gorilla/mux"
)
```

下次运行 `go build` 或 `go test` 时，Go 会自动下载所需的软件包，更新 go.mod 和 go.sum 文件，并将项目配置为使用指定的软件包。或者，也可以使用 go get 命令明确添加新的依赖关系：

```go
go get github.com/gorilla/mux
```

这不仅会获取软件包，还会更新项目的 go.mod 和 go.sum 文件。

要将特定依赖项更新到新版本，请使用以下命令，go get后跟包导入路径和所需的版本号：

```go
go get github.com/gorilla/mux@v1.8.0
```

要从项目中删除依赖项，首先从源代码中删除相应的导入语句。然后，运行`go mod tidy`命令来清理文件 go.mod：

```go
go mod tidy
```

### 3.3 依赖冲突

当你的项目依赖于多个软件包，而这些软件包对共享依赖项的版本要求各不相同时，就会产生依赖冲突。Go 模块提供了一种内置机制，可使用 go.mod 文件中的`replace`和`exclude`指令来处理这些冲突。

`replace`允许将模块的版本更改为其他版本或将其映射到本地路径。这在您需要在提交到远程存储库之前测试特定版本、分叉项目或本地更改的情况下非常有用。

```go
replace example.com/original/module v1.2.3 => example.com/new/module v1.4.0
replace example.com/original/module v1.2.3 => ../local/path/to/new/module
```

`exclude`可以防止在项目中使用模块的特定版本。当您知道特定版本存在兼容性问题或安全漏洞时，这非常有用。

```go
exclude example.com/target/module v1.2.3
```

参考资料：

* [A Guide to Semantic Versioning](https://www.baeldung.com/cs/semantic-versioning)
* [Go Modules Reference](https://go.dev/ref/mod#modules-overview)
* [Go Modules and Dependency Management](https://appmaster.io/blog/go-modules-dependency-management#adding-a-dependency)
